<html>
<div>
	<input type="file" id="input">
</div>
<div>
	<input type="text" id="output">
</div>
<canvas id="canvas" width="150" height="150"></canvas>

<script>
'use strict'
let log = console.log.bind(console);
//DOM references
const canvas = document.getElementById('canvas');
const output = document.getElementById('output');
const ctx = canvas.getContext('2d');

const origin_offset=-51.224998;
const resolution=0.05;
/*/
//PGM FILE FORMAT//
P5
# CREATOR: GIMP PNM Filter Version 1.1
2048 2048
255
<data>
/*/

<!-- if (canvas.getContext) { -->
	<!-- let imageData = ctx.createImageData(100, 50);	//rectangle size -->
	<!-- log(imageData); -->
	
	<!-- // Iterate through every pixel -->
	<!-- for (let i = 0; i < imageData.data.length; i += 4) { -->
		<!-- // Modify pixel data -->
		<!-- imageData.data[i + 0] = 190;  // R value -->
		<!-- imageData.data[i + 1] = 0;    // G value -->
		<!-- imageData.data[i + 2] = 210;  // B value -->
		<!-- imageData.data[i + 3] = 255;  // A value -->
	<!-- } -->

	<!-- // Draw image data to the canvas -->
	<!-- ctx.putImageData(imageData, 0, 0);	//rectangle position -->
<!-- } -->

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function getMousePos(canvas, evt) {
	var rect = canvas.getBoundingClientRect();
	return {
		x: evt.clientX - rect.left,
		y: evt.clientY - rect.top
	};
}
function getRvizPos(mousePos){
	return{
		x: mousePos.x * resolution + origin_offset,
		y: (canvas.height - mousePos.y) * resolution + origin_offset
	};
}


let fr = new FileReader();
fr.onload = async function(e) {
	let bytes = new Uint8Array(fr.result);
	let line=0;
	let fileType="";
	let hv="";
	let maxWhiteVal="";
	let imageData;
	let dataI=0;
	
	for (let i=0; i<bytes.length; i++){
		//newline check- save header info respectively
		if (bytes[i]==10){
			line++;
			if (line==1) {
				log("Filetype: "+fileType);
				if (fileType!="P5") {
					log("Unhandled file type: "+fileType);
					return;
				}
			}
			else if (line==3){
				hv=hv.split(" ");
				canvas.width=hv[0];
				canvas.height=hv[1];
				imageData = ctx.getImageData (0, 0, hv[0], hv[1]);
				log("Dimensions: "+hv[0]+"x"+hv[1])
			}
			else if (line==4){
				log("Max White Value: "+maxWhiteVal);
			}
			continue;
		}
		
		//check line data
		//PGM format
		if (line==0){
			fileType+=String.fromCharCode(bytes[i]);
		}
		//file comments/metadata
		else if (line==1){
		}
		//size: horizontal & vertical
		else if (line==2){
			hv+=String.fromCharCode(bytes[i]);
		}
		//max white value
		else if (line==3){
			maxWhiteVal+=String.fromCharCode(bytes[i]);
		}
		//data
		else{
			// Iterate through every pixel
			if (dataI < imageData.data.length) {
				let val=maxWhiteVal*bytes[i]/maxWhiteVal;
				// Modify pixel data
				imageData.data[dataI + 0] = val;	// R value
				imageData.data[dataI + 1] = val;	// G value
				imageData.data[dataI + 2] = val;	// B value
				imageData.data[dataI + 3] = maxWhiteVal;	// A value
				dataI+=4;
			}
		}
		//await sleep(1000);
	}
	// Draw image data to the canvas
	ctx.putImageData(imageData, 0, 0);	//rectangle position
}


canvas.addEventListener('mousemove', function(evt) {
	//let mousePos = getMousePos(canvas, evt);
	let rvizPos = getRvizPos(getMousePos(canvas, evt));
	let message = 'Mouse position: ' + rvizPos.x + ',' + rvizPos.y;
	log(message);
}, false);

let waypoint=[];
canvas.addEventListener('click', function(evt) {
	//let mousePos = getMousePos(canvas, evt);
	let rvizPos = getRvizPos(getMousePos(canvas, evt));
	let message = "Clicked!";
	log(message);
}, false);
function updateCanvas() {
	//10:/n 35:#
	fr.readAsArrayBuffer(this.files[0]);
}
document.getElementById("input").addEventListener("change", updateCanvas, false);
</script>
</html>